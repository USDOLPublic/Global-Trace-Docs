<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>Global Trace BE documentation</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="icon" type="image/x-icon" href="../images/favicon.ico">
	   <link rel="stylesheet" href="../styles/style.css">
        <link rel="stylesheet" href="../styles/dark.css">
    </head>
    <body>
          <script>
               // Blocking script to avoid flickering dark mode
               // Dark mode toggle button
               var useDark = window.matchMedia('(prefers-color-scheme: dark)');
               var darkModeState = useDark.matches;
               var $darkModeToggleSwitchers = document.querySelectorAll('.dark-mode-switch input');
               var $darkModeToggles = document.querySelectorAll('.dark-mode-switch');
               var darkModeStateLocal = localStorage.getItem('compodoc_darkmode-state');

               function checkToggle(check) {
                    for (var i = 0; i < $darkModeToggleSwitchers.length; i++) {
                         $darkModeToggleSwitchers[i].checked = check;
                    }
               }

               function toggleDarkMode(state) {
                    if (window.localStorage) {
                         localStorage.setItem('compodoc_darkmode-state', state);
                    }

                    checkToggle(state);

                    const hasClass = document.body.classList.contains('dark');

                    if (state) {
                         for (var i = 0; i < $darkModeToggles.length; i++) {
                              $darkModeToggles[i].classList.add('dark');
                         }
                         if (!hasClass) {
                              document.body.classList.add('dark');
                         }
                    } else {
                         for (var i = 0; i < $darkModeToggles.length; i++) {
                              $darkModeToggles[i].classList.remove('dark');
                         }
                         if (hasClass) {
                              document.body.classList.remove('dark');
                         }
                    }
               }

               useDark.addEventListener('change', function (evt) {
                    toggleDarkMode(evt.matches);
               });
               if (darkModeStateLocal) {
                    darkModeState = darkModeStateLocal === 'true';
               }
               toggleDarkMode(darkModeState);
          </script>

        <div class="navbar navbar-default navbar-fixed-top d-md-none p-0">
               <div class="d-flex">
                    <a href="../" class="navbar-brand">Global Trace BE documentation</a>
                    <button type="button" class="btn btn-default btn-menu ion-ios-menu" id="btn-menu"></button>
               </div>
        </div>

        <div class="xs-menu menu" id="mobile-menu">
                <div id="book-search-input" role="search"><input type="text" placeholder="Type to search"></div>            <compodoc-menu></compodoc-menu>
        </div>

        <div class="container-fluid main">
           <div class="row main">
               <div class="d-none d-md-block menu">
                   <compodoc-menu mode="normal"></compodoc-menu>
               </div>
               <!-- START CONTENT -->
               <div class="content injectable">
                   <div class="content-data">








<ol class="breadcrumb">
  <li class="breadcrumb-item">Injectables</li>
  <li class="breadcrumb-item" >TaxonomyExploitationUploadService</li>
</ol>

<ul class="nav nav-tabs" role="tablist">
        <li class="nav-item">
            <a href="#info" 
                class="nav-link"
                class="nav-link active"
                role="tab" id="info-tab" data-bs-toggle="tab" data-link="info">Info</a>
        </li>
        <li class="nav-item">
            <a href="#source" 
                class="nav-link"
                
                role="tab" id="source-tab" data-bs-toggle="tab" data-link="source">Source</a>
        </li>
</ul>

<div class="tab-content">
    <div class="tab-pane fade active in" id="info">
        <p class="comment">
            <h3>File</h3>
        </p>
        <p class="comment">
            <code>src/taxonomy-exploitations/services/taxonomy-exploitation-upload.service.ts</code>
        </p>



            <p class="comment">
                <h3>Extends</h3>
            </p>
            <p class="comment">
                        <code>TransactionService</code>
            </p>


            <section data-compodoc="block-index">
    <h3 id="index">Index</h3>
    <table class="table table-sm table-bordered index-table">
        <tbody>

                <tr>
                    <td class="col-md-4">
                        <h6><b>Methods</b></h6>
                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <ul class="index-list">
                            <li>
                                    <span class="modifier">Private</span>
                                <a href="#extractFileData" >extractFileData</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                <a href="#extractRowData" >extractRowData</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#getFileById" >getFileById</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#importTaxonomiesOfExploitation" >importTaxonomiesOfExploitation</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                    <span class="modifier">Async</span>
                                <a href="#initWorkbook" >initWorkbook</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                    <span class="modifier">Async</span>
                                <a href="#insertCategories" >insertCategories</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                <a href="#insertedSubIndicators" >insertedSubIndicators</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                    <span class="modifier">Async</span>
                                <a href="#readFileById" >readFileById</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                    <span class="modifier">Async</span>
                                <a href="#sanitizeData" >sanitizeData</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                    <span class="modifier">Async</span>
                                <a href="#saveIndicatorAndSubIndicators" >saveIndicatorAndSubIndicators</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                <a href="#setRowData" >setRowData</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#uploadAndValidateTemplateData" >uploadAndValidateTemplateData</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#uploadFile" >uploadFile</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                    <span class="modifier">Async</span>
                                <a href="#validate" >validate</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#validateDataImport" >validateDataImport</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                <a href="#validateItems" >validateItems</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                <a href="#validHeaderFileUpload" >validHeaderFileUpload</a>
                            </li>
                        </ul>
                    </td>
                </tr>





                    <tr>
                        <td class="col-md-4">
                            <h6><b>Accessors</b></h6>
                        </td>
                    </tr>
                    <tr>
                        <td class="col-md-4">
                            <ul class="index-list">
                                <li>
                                    <a href="#schema" >schema</a>
                                </li>
                            </ul>
                        </td>
                    </tr>
        </tbody>
    </table>
</section>

            <section data-compodoc="block-constructor">
    <h3 id="constructor">Constructor</h3>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
                                <span class="modifier">Public</span>
                        <code>constructor(taxonomyExploitationFileRepo: <a href="../classes/TaxonomyExploitationFileRepository.html" target="_self">TaxonomyExploitationFileRepository</a>, storageService: StorageService, categoryRepo: <a href="../classes/CategoryRepository.html" target="_self">CategoryRepository</a>)</code>
                    </td>
                </tr>
                        <tr>
                            <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="35" class="link-to-prism">src/taxonomy-exploitations/services/taxonomy-exploitation-upload.service.ts:35</a></div>
                            </td>
                        </tr>

                <tr>
                    <td class="col-md-4">
                            <div>
                                    <b>Parameters :</b>
                                    <table class="params">
                                        <thead>
                                            <tr>
                                                <td>Name</td>
                                                    <td>Type</td>
                                                <td>Optional</td>
                                            </tr>
                                        </thead>
                                        <tbody>
                                                <tr>
                                                        <td>taxonomyExploitationFileRepo</td>
                                                  
                                                        <td>
                                                                        <code><a href="../classes/TaxonomyExploitationFileRepository.html" target="_self" >TaxonomyExploitationFileRepository</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>storageService</td>
                                                  
                                                        <td>
                                                                    <code>StorageService</code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>categoryRepo</td>
                                                  
                                                        <td>
                                                                        <code><a href="../classes/CategoryRepository.html" target="_self" >CategoryRepository</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                        </tbody>
                                    </table>
                            </div>
                    </td>
                </tr>
            </tbody>
        </table>
</section>

            <section data-compodoc="block-methods">
    
    <h3 id="methods">
        Methods
    </h3>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="extractFileData"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                        <span ><b>extractFileData</b></span>
                        <a href="#extractFileData"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>extractFileData(worksheet: Worksheet, isTakeValidatedData: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/boolean" target="_blank">boolean</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="135"
                                    class="link-to-prism">src/taxonomy-exploitations/services/taxonomy-exploitation-upload.service.ts:135</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                                <td>Default value</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>worksheet</td>
                                            <td>
                                                        <code>Worksheet</code>
                                            </td>

                                            <td>
                                                    No
                                            </td>

                                            <td>
                                            </td>

                                        </tr>
                                        <tr>
                                                <td>isTakeValidatedData</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/boolean" target="_blank" >boolean</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>

                                            <td>
                                                    <code>false</code>
                                            </td>

                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>{}</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="extractRowData"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                        <span ><b>extractRowData</b></span>
                        <a href="#extractRowData"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>extractRowData(row: Row)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="150"
                                    class="link-to-prism">src/taxonomy-exploitations/services/taxonomy-exploitation-upload.service.ts:150</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>row</td>
                                            <td>
                                                        <code>Row</code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="../interfaces/UploadTaxonomyExploitationInterface.html" target="_self" >UploadTaxonomyExploitationInterface&lt;CellValue&gt;</a></code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getFileById"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>getFileById</b></span>
                        <a href="#getFileById"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getFileById(id: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="247"
                                    class="link-to-prism">src/taxonomy-exploitations/services/taxonomy-exploitation-upload.service.ts:247</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>id</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;NodeJS.ReadableStream&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="importTaxonomiesOfExploitation"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>importTaxonomiesOfExploitation</b></span>
                        <a href="#importTaxonomiesOfExploitation"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>importTaxonomiesOfExploitation(fileId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, action: <a href="../undefineds/UploadTaxonomyExploitationActionEnum.html" target="_self">UploadTaxonomyExploitationActionEnum</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="268"
                                    class="link-to-prism">src/taxonomy-exploitations/services/taxonomy-exploitation-upload.service.ts:268</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>fileId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>action</td>
                                            <td>
                                                            <code><a href="../miscellaneous/enumerations.html#UploadTaxonomyExploitationActionEnum" target="_self" >UploadTaxonomyExploitationActionEnum</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="../miscellaneous/functions.html#now" target="_self" >unknown</a></code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="initWorkbook"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                            <span class="modifier">Async</span>
                        <span ><b>initWorkbook</b></span>
                        <a href="#initWorkbook"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>initWorkbook(fileOrStream: Express.Multer.File | NodeJS.ReadableStream)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="110"
                                    class="link-to-prism">src/taxonomy-exploitations/services/taxonomy-exploitation-upload.service.ts:110</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>fileOrStream</td>
                                            <td>
                                                        <code>Express.Multer.File | NodeJS.ReadableStream</code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="../miscellaneous/typealiases.html#WorkBookInitialization" target="_self" >Promise&lt;WorkBookInitialization&gt;</a></code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="insertCategories"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                            <span class="modifier">Async</span>
                        <span ><b>insertCategories</b></span>
                        <a href="#insertCategories"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>insertCategories(categories: string[])</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="340"
                                    class="link-to-prism">src/taxonomy-exploitations/services/taxonomy-exploitation-upload.service.ts:340</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>categories</td>
                                            <td>
                                                        <code>string[]</code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="../miscellaneous/functions.html#now" target="_self" >unknown</a></code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="insertedSubIndicators"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                        <span ><b>insertedSubIndicators</b></span>
                        <a href="#insertedSubIndicators"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>insertedSubIndicators(insertedSubIndicator: <a href="../interfaces/UploadTaxonomyExploitationInterface.html" target="_self">UploadTaxonomyExploitationInterface&lt;CellValue&gt;[]</a>, foundIndicator: <a href="../entitys/CategoryEntity.html" target="_self">CategoryEntity</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="373"
                                    class="link-to-prism">src/taxonomy-exploitations/services/taxonomy-exploitation-upload.service.ts:373</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>insertedSubIndicator</td>
                                            <td>
                                                            <code><a href="../interfaces/UploadTaxonomyExploitationInterface.html" target="_self" >UploadTaxonomyExploitationInterface&lt;CellValue&gt;[]</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>foundIndicator</td>
                                            <td>
                                                            <code><a href="../entitys/CategoryEntity.html" target="_self" >CategoryEntity</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >any</a></code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="readFileById"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                            <span class="modifier">Async</span>
                        <span ><b>readFileById</b></span>
                        <a href="#readFileById"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>readFileById(id: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="252"
                                    class="link-to-prism">src/taxonomy-exploitations/services/taxonomy-exploitation-upload.service.ts:252</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>id</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="../miscellaneous/typealiases.html#WorkBookInitialization" target="_self" >Promise&lt;WorkBookInitialization&gt;</a></code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="sanitizeData"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                            <span class="modifier">Async</span>
                        <span ><b>sanitizeData</b></span>
                        <a href="#sanitizeData"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>sanitizeData(fileTemplateData: <a href="../interfaces/UploadTaxonomyExploitationInterface.html" target="_self">UploadTaxonomyExploitationInterface&lt;CellValue&gt;[]</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="329"
                                    class="link-to-prism">src/taxonomy-exploitations/services/taxonomy-exploitation-upload.service.ts:329</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>fileTemplateData</td>
                                            <td>
                                                            <code><a href="../interfaces/UploadTaxonomyExploitationInterface.html" target="_self" >UploadTaxonomyExploitationInterface&lt;CellValue&gt;[]</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="../miscellaneous/functions.html#now" target="_self" >unknown</a></code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="saveIndicatorAndSubIndicators"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                            <span class="modifier">Async</span>
                        <span ><b>saveIndicatorAndSubIndicators</b></span>
                        <a href="#saveIndicatorAndSubIndicators"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>saveIndicatorAndSubIndicators(groupedSubIndicators: <a href="../interfaces/UploadTaxonomyExploitationInterface.html" target="_self">UploadTaxonomyExploitationInterface&lt;CellValue&gt;[]</a>, categoriesGroupName: <a href="../entitys/CategoryEntity.html" target="_self">Dictionary&lt;CategoryEntity&gt;</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="357"
                                    class="link-to-prism">src/taxonomy-exploitations/services/taxonomy-exploitation-upload.service.ts:357</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>groupedSubIndicators</td>
                                            <td>
                                                            <code><a href="../interfaces/UploadTaxonomyExploitationInterface.html" target="_self" >UploadTaxonomyExploitationInterface&lt;CellValue&gt;[]</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>categoriesGroupName</td>
                                            <td>
                                                            <code><a href="../entitys/CategoryEntity.html" target="_self" >Dictionary&lt;CategoryEntity&gt;</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >any</a></code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="setRowData"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                        <span ><b>setRowData</b></span>
                        <a href="#setRowData"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>setRowData(worksheet: Worksheet, rowIndex: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank">number</a>, cellIndexOrKey: number | string, value: CellValue)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="162"
                                    class="link-to-prism">src/taxonomy-exploitations/services/taxonomy-exploitation-upload.service.ts:162</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>worksheet</td>
                                            <td>
                                                        <code>Worksheet</code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>rowIndex</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>cellIndexOrKey</td>
                                            <td>
                                                        <code>number | string</code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>value</td>
                                            <td>
                                                        <code>CellValue</code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >void</a></code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="uploadAndValidateTemplateData"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>uploadAndValidateTemplateData</b></span>
                        <a href="#uploadAndValidateTemplateData"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>uploadAndValidateTemplateData(file: Express.Multer.File)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="101"
                                    class="link-to-prism">src/taxonomy-exploitations/services/taxonomy-exploitation-upload.service.ts:101</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>file</td>
                                            <td>
                                                        <code>Express.Multer.File</code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="../classes/UploadTemplateResponse.html" target="_self" >Promise&lt;UploadTemplateResponse&gt;</a></code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="uploadFile"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>uploadFile</b></span>
                        <a href="#uploadFile"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>uploadFile(file: Express.Multer.File, workbook: Workbook, isValidated: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/boolean" target="_blank">boolean</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="225"
                                    class="link-to-prism">src/taxonomy-exploitations/services/taxonomy-exploitation-upload.service.ts:225</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>file</td>
                                            <td>
                                                        <code>Express.Multer.File</code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>workbook</td>
                                            <td>
                                                        <code>Workbook</code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>isValidated</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/boolean" target="_blank" >boolean</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;TaxonomyExploitationFileEntity&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="validate"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                            <span class="modifier">Async</span>
                        <span ><b>validate</b></span>
                        <a href="#validate"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>validate(fileTemplateData: <a href="../interfaces/UploadTaxonomyExploitationInterface.html" target="_self">UploadTaxonomyExploitationInterface&lt;CellValue&gt;[]</a>, worksheet: Worksheet)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="197"
                                    class="link-to-prism">src/taxonomy-exploitations/services/taxonomy-exploitation-upload.service.ts:197</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>fileTemplateData</td>
                                            <td>
                                                            <code><a href="../interfaces/UploadTaxonomyExploitationInterface.html" target="_self" >UploadTaxonomyExploitationInterface&lt;CellValue&gt;[]</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>worksheet</td>
                                            <td>
                                                        <code>Worksheet</code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;TaxonomyExploitationRowValidationResultType&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="validateDataImport"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>validateDataImport</b></span>
                        <a href="#validateDataImport"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>validateDataImport(sanitizeData: <a href="../interfaces/UploadTaxonomyExploitationInterface.html" target="_self">UploadTaxonomyExploitationInterface&lt;CellValue&gt;[]</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="310"
                                    class="link-to-prism">src/taxonomy-exploitations/services/taxonomy-exploitation-upload.service.ts:310</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>sanitizeData</td>
                                            <td>
                                                            <code><a href="../interfaces/UploadTaxonomyExploitationInterface.html" target="_self" >UploadTaxonomyExploitationInterface&lt;CellValue&gt;[]</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;void&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="validateItems"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                        <span ><b>validateItems</b></span>
                        <a href="#validateItems"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>validateItems(undefined: <a href="../undefineds/TaxonomyExploitationValidationParams.html" target="_self">TaxonomyExploitationValidationParams</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="171"
                                    class="link-to-prism">src/taxonomy-exploitations/services/taxonomy-exploitation-upload.service.ts:171</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>
                                                            <code><a href="../miscellaneous/typealiases.html#TaxonomyExploitationValidationParams" target="_self" >TaxonomyExploitationValidationParams</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="../miscellaneous/typealiases.html#TaxonomyExploitationValidationParams" target="_self" >TaxonomyExploitationValidationParams</a></code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="validHeaderFileUpload"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                        <span ><b>validHeaderFileUpload</b></span>
                        <a href="#validHeaderFileUpload"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>validHeaderFileUpload(worksheet: Worksheet)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="124"
                                    class="link-to-prism">src/taxonomy-exploitations/services/taxonomy-exploitation-upload.service.ts:124</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>worksheet</td>
                                            <td>
                                                        <code>Worksheet</code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >void</a></code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
</section>

            <section data-compodoc="block-accessors">
    <h3 id="accessors">
        Accessors
    </h3>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
                        <a name="schema"></a>
                        <span class="name"><b>schema</b><a href="#schema"><span class="icon ion-ios-link"></span></a></span>
                    </td>
                </tr>

                <tr>
                    <td class="col-md-4">
                        <span class="accessor"><b>get</b><code>schema()</code></span>
                    </td>
                </tr>
                            <tr>
                                <td class="col-md-4">
                                    <div class="io-line">Defined in <a href="" data-line="46" class="link-to-prism">src/taxonomy-exploitations/services/taxonomy-exploitation-upload.service.ts:46</a></div>
                                </td>
                            </tr>

            </tbody>
        </table>
</section>
    </div>


    <div class="tab-pane fade  tab-source-code" id="source">
        <pre class="line-numbers compodoc-sourcecode"><code class="language-typescript">import { trans } from &#x27;@diginexhk/nestjs-cls-translation&#x27;;
import { StorageService, generateUniqueName } from &#x27;@diginexhk/nestjs-storage&#x27;;
import { TransactionService } from &#x27;@diginexhk/nestjs-transaction&#x27;;
import { BadRequestException, Injectable } from &#x27;@nestjs/common&#x27;;
import { CellValue, Row, Workbook, Worksheet } from &#x27;exceljs&#x27;;
import Joi from &#x27;joi&#x27;;
import { Dictionary, cloneDeep, get, groupBy, keyBy, trim, uniqBy } from &#x27;lodash&#x27;;
import { Readable } from &#x27;stream&#x27;;
import { IsNull } from &#x27;typeorm&#x27;;
import { CategoryEntity } from &#x27;~categories/entities/category.entity&#x27;;
import { CategoryTypeEnum } from &#x27;~categories/enums/category-type.enum&#x27;;
import { CategoryRepository } from &#x27;~categories/repositories/category.repository&#x27;;
import { ErrorTypeEnum } from &#x27;~files/enums/error-type.enum&#x27;;
import { UploadTaxonomyExploitationActionEnum } from &#x27;~files/enums/upload-taxonomy-of-exploitation-action.enum&#x27;;
import { addErrorValidation } from &#x27;~files/helpers/add-error-validation.helper&#x27;;
import { initWorkbook } from &#x27;~files/helpers/file.helper&#x27;;
import { checkIfBlankRow } from &#x27;~files/helpers/is-blank-row.helper&#x27;;
import { UploadTemplateResponse } from &#x27;~files/http/response/upload-template.response&#x27;;
import { FileDataValidationType } from &#x27;~files/types/file-data-validation.type&#x27;;
import { WorkBookInitialization } from &#x27;~files/types/work-book-initialization.type&#x27;;
import {
    SHEET_1_HEADER_KEYS,
    SHEET_1_HEADER_NAMES,
    SHEET_1_TEMPLATE_HEADERS
} from &#x27;~taxonomy-exploitations/constants/taxonomy-exploitation.constants&#x27;;
import { TaxonomyExploitationFileEntity } from &#x27;~taxonomy-exploitations/entities/taxonomy-exploitation-file.entity&#x27;;
import { RiskSeverityEnum } from &#x27;~taxonomy-exploitations/enums/risk-severity.enum&#x27;;
import { UploadTaxonomyExploitationInterface } from &#x27;~taxonomy-exploitations/interfaces/upload-taxonomy-exploitation-template.interface&#x27;;
import { TaxonomyExploitationFileRepository } from &#x27;~taxonomy-exploitations/repositories/taxonomy-exploitation-file.repository&#x27;;
import { FileTaxonomyExploitationValidation } from &#x27;~taxonomy-exploitations/types/file-taxonomy-exploitation-validation.type&#x27;;
import { TaxonomyExploitationRowValidationResultType } from &#x27;~taxonomy-exploitations/types/taxonomy-exploitation-row-validation-result.type&#x27;;
import { TaxonomyExploitationValidationParams } from &#x27;~taxonomy-exploitations/types/taxonomy-exploitation-validation-params.type&#x27;;

@Injectable()
export class TaxonomyExploitationUploadService extends TransactionService {
    public constructor(
        private taxonomyExploitationFileRepo: TaxonomyExploitationFileRepository,
        private storageService: StorageService,
        private categoryRepo: CategoryRepository
    ) {
        super();
    }

    /* eslint-disable @typescript-eslint/naming-convention */
    // eslint-disable-next-line max-lines-per-function
    get schema() {
        return Joi.object({
            country: Joi.string()
                .max(255)
                .required()
                .messages({
                    &#x27;string.base&#x27;: trans(&#x27;import.invalid_country&#x27;),
                    &#x27;string.empty&#x27;: trans(&#x27;import.require_country&#x27;),
                    &#x27;string.max&#x27;: trans(&#x27;import.max_length_country&#x27;)
                }),
            sector: Joi.string()
                .max(255)
                .required()
                .messages({
                    &#x27;string.base&#x27;: trans(&#x27;import.invalid_sector&#x27;),
                    &#x27;string.empty&#x27;: trans(&#x27;import.require_sector&#x27;),
                    &#x27;string.max&#x27;: trans(&#x27;import.max_length_sector&#x27;)
                }),
            category: Joi.string()
                .max(255)
                .required()
                .messages({
                    &#x27;string.base&#x27;: trans(&#x27;import.invalid_category&#x27;),
                    &#x27;string.empty&#x27;: trans(&#x27;import.require_category&#x27;),
                    &#x27;string.max&#x27;: trans(&#x27;import.max_length_category&#x27;)
                }),
            indicator: Joi.string()
                .max(1000)
                .required()
                .messages({
                    &#x27;string.base&#x27;: trans(&#x27;import.invalid_indicator&#x27;),
                    &#x27;string.empty&#x27;: trans(&#x27;import.require_indicator&#x27;),
                    &#x27;string.max&#x27;: trans(&#x27;import.max_length_indicator&#x27;)
                }),
            subIndicator: Joi.string()
                .max(1000)
                .required()
                .messages({
                    &#x27;string.base&#x27;: trans(&#x27;import.invalid_sub_indicator&#x27;),
                    &#x27;string.empty&#x27;: trans(&#x27;import.require_sub_indicator&#x27;),
                    &#x27;string.max&#x27;: trans(&#x27;import.max_length_sub_indicator&#x27;)
                }),
            severity: Joi.number()
                .required()
                .valid(...Object.values(RiskSeverityEnum))
                .messages({
                    &#x27;any.only&#x27;: trans(&#x27;import.invalid_severity&#x27;),
                    &#x27;number.base&#x27;: trans(&#x27;import.severity_must_be_number&#x27;),
                    &#x27;number.empty&#x27;: trans(&#x27;import.require_severity&#x27;)
                }),
            isBlankRow: Joi.boolean()
        });
    }
    /* eslint-enable @typescript-eslint/naming-convention */

    async uploadAndValidateTemplateData(file: Express.Multer.File): Promise&lt;UploadTemplateResponse&gt; {
        const { workbook, worksheet } &#x3D; await this.initWorkbook(file);
        const data &#x3D; this.extractFileData(worksheet);
        const { totalItems, validatedItemCount, validationErrors } &#x3D; await this.validate(data, worksheet);
        const uploadedFile &#x3D; await this.uploadFile(file, workbook, !!!validationErrors.length);

        return { fileId: uploadedFile.id, totalItems, validatedItemCount, validationErrors };
    }

    private async initWorkbook(
        fileOrStream: Express.Multer.File | NodeJS.ReadableStream
    ): Promise&lt;WorkBookInitialization&gt; {
        const workbook &#x3D; await initWorkbook(fileOrStream);
        if (!workbook.worksheets.length) {
            throw new BadRequestException({ translate: &#x27;error.incorrect_format_upload&#x27; });
        }
        const worksheet &#x3D; workbook.worksheets[0];
        this.validHeaderFileUpload(worksheet);
        worksheet.columns &#x3D; cloneDeep(SHEET_1_TEMPLATE_HEADERS);

        return { workbook, worksheet };
    }

    private validHeaderFileUpload(worksheet: Worksheet) {
        const sheetHeaders &#x3D; worksheet.getRow(1);
        let key &#x3D; 1;
        for (const value of Object.values(SHEET_1_HEADER_NAMES)) {
            if (sheetHeaders.getCell(key).value !&#x3D;&#x3D; value) {
                throw new BadRequestException({ translate: &#x27;error.incorrect_format_upload&#x27; });
            }
            key++;
        }
    }

    private extractFileData(worksheet: Worksheet, isTakeValidatedData: boolean &#x3D; false) {
        const reportData: UploadTaxonomyExploitationInterface&lt;CellValue&gt;[] &#x3D; [];
        worksheet.eachRow({ includeEmpty: false }, (row, rowNumber) &#x3D;&gt; {
            const isValidated &#x3D; isTakeValidatedData
                ? worksheet.getRow(rowNumber).getCell(SHEET_1_HEADER_KEYS.IS_VALIDATED)?.toString() &#x3D;&#x3D;&#x3D; &#x27;true&#x27;
                : true;

            if (rowNumber &gt; 1 &amp;&amp; isValidated) {
                reportData.push(this.extractRowData(row));
            }
        });

        return reportData;
    }

    private extractRowData(row: Row): UploadTaxonomyExploitationInterface&lt;CellValue&gt; {
        return {
            country: trim(row.getCell(SHEET_1_HEADER_KEYS.COUNTRY).toString()),
            sector: trim(row.getCell(SHEET_1_HEADER_KEYS.SECTOR).toString()),
            category: trim(row.getCell(SHEET_1_HEADER_KEYS.CATEGORY).toString()),
            indicator: trim(row.getCell(SHEET_1_HEADER_KEYS.INDICATOR).toString()),
            subIndicator: trim(row.getCell(SHEET_1_HEADER_KEYS.SUB_INDICATOR).toString()),
            severity: row.getCell(SHEET_1_HEADER_KEYS.SEVERITY).value,
            isBlankRow: checkIfBlankRow(row, SHEET_1_TEMPLATE_HEADERS)
        };
    }

    private setRowData(
        worksheet: Worksheet,
        rowIndex: number,
        cellIndexOrKey: number | string,
        value: CellValue
    ): void {
        worksheet.getRow(rowIndex).getCell(cellIndexOrKey).value &#x3D; value;
    }

    private validateItems({
        error,
        errors,
        currentRowIndex,
        rowData,
        validatedItemCount,
        worksheet,
        rowIndex,
        isBlankRow
    }: TaxonomyExploitationValidationParams) {
        if (error) {
            addErrorValidation({
                currentListErrors: errors,
                errors: error.details,
                errorType: ErrorTypeEnum.JOI,
                currentRowIndex,
                isBlankRow
            });
        } else {
            validatedItemCount++;
            this.setRowData(worksheet, rowIndex + 2, SHEET_1_HEADER_KEYS.IS_VALIDATED, true);
        }

        return validatedItemCount;
    }

    private async validate(
        fileTemplateData: UploadTaxonomyExploitationInterface&lt;CellValue&gt;[],
        worksheet: Worksheet
    ): Promise&lt;TaxonomyExploitationRowValidationResultType&gt; {
        const errors: FileDataValidationType[] &#x3D; [];
        let validatedItemCount &#x3D; 0;

        fileTemplateData.forEach(async (rowData, index) &#x3D;&gt; {
            let currentRowIndex &#x3D; index + 2;
            const schema &#x3D; this.schema;
            const { error } &#x3D; schema.validate(rowData, { abortEarly: false });

            validatedItemCount &#x3D; this.validateItems({
                error,
                errors,
                currentRowIndex,
                rowData,
                validatedItemCount,
                worksheet,
                rowIndex: +index,
                isBlankRow: rowData.isBlankRow
            });
        });

        const totalItems &#x3D; fileTemplateData.filter(({ isBlankRow }) &#x3D;&gt; !isBlankRow).length;
        return { totalItems, validatedItemCount, validationErrors: errors };
    }

    async uploadFile(
        file: Express.Multer.File,
        workbook: Workbook,
        isValidated: boolean
    ): Promise&lt;TaxonomyExploitationFileEntity&gt; {
        let blobClient;

        if (file.mimetype &#x3D;&#x3D;&#x3D; &#x27;text/csv&#x27;) {
            const buffer &#x3D; await workbook.csv.writeBuffer();
            const stream &#x3D; Readable.from(buffer.toString());
            blobClient &#x3D; await this.storageService.uploadStream(stream, generateUniqueName(file.originalname));
        } else {
            const buffer &#x3D; await workbook.xlsx.writeBuffer();
            blobClient &#x3D; await this.storageService.uploadFile({
                file: buffer as Buffer,
                fileName: generateUniqueName(file.originalname)
            });
        }

        return this.taxonomyExploitationFileRepo.createOne({ blobName: blobClient.blobName, isValidated });
    }

    async getFileById(id: string): Promise&lt;NodeJS.ReadableStream&gt; {
        const file &#x3D; await this.taxonomyExploitationFileRepo.findById(id);
        return this.storageService.getFileStream(file.blobName);
    }

    private async readFileById(id: string): Promise&lt;WorkBookInitialization&gt; {
        const file &#x3D; await this.taxonomyExploitationFileRepo.findById(id);

        if (!file.isValidated) {
            throw new BadRequestException({ translate: &#x27;error.not_validated_taxonomy_exploitation_upload_file&#x27; });
        }

        if (file.isImported) {
            throw new BadRequestException({ translate: &#x27;error.imported_taxonomy_exploitation_upload_file&#x27; });
        }

        const fileStream &#x3D; await this.storageService.getFileStream(file.blobName);

        return this.initWorkbook(fileStream);
    }

    async importTaxonomiesOfExploitation(fileId: string, action: UploadTaxonomyExploitationActionEnum) {
        const { worksheet } &#x3D; await this.readFileById(fileId);
        const data &#x3D; this.extractFileData(worksheet, true) as UploadTaxonomyExploitationInterface&lt;string&gt;[];
        const sanitizeData &#x3D; await this.sanitizeData(data);
        const indicators &#x3D; groupBy(sanitizeData, &#x27;indicator&#x27;);
        if (action &#x3D;&#x3D;&#x3D; UploadTaxonomyExploitationActionEnum.REPLACE) {
            await this.categoryRepo.softDelete({
                deletedAt: IsNull()
            });
        }
        await this.validateDataImport(sanitizeData);
        const groupedCategories &#x3D; groupBy(sanitizeData, &#x27;category&#x27;);
        const categories &#x3D; await this.insertCategories(Object.keys(groupedCategories));
        const categoriesKeyName &#x3D; keyBy(categories, &#x27;name&#x27;);
        const errors: FileTaxonomyExploitationValidation[] &#x3D; [];
        for (const indicatorName of Object.keys(indicators)) {
            const groupedSubIndicators &#x3D; indicators[indicatorName];
            if (action &#x3D;&#x3D;&#x3D; UploadTaxonomyExploitationActionEnum.REPLACE) {
                await this.saveIndicatorAndSubIndicators(groupedSubIndicators, categoriesKeyName);
                continue;
            }
            const foundIndicator &#x3D; await this.categoryRepo.findOne({
                where: { name: indicatorName },
                relations: [&#x27;subIndicators&#x27;, &#x27;category&#x27;]
            });
            if (!foundIndicator) {
                await this.saveIndicatorAndSubIndicators(groupedSubIndicators, categoriesKeyName);
                continue;
            }
            const insertedSubIndicators &#x3D; groupedSubIndicators.filter(
                ({ subIndicator }) &#x3D;&gt; !!!foundIndicator.subIndicators.find(({ name }) &#x3D;&gt; name &#x3D;&#x3D;&#x3D; subIndicator)
            );
            await this.insertedSubIndicators(insertedSubIndicators, foundIndicator);
        }
        await this.taxonomyExploitationFileRepo.update(fileId, { isImported: true, action });
        return {
            totalItems: sanitizeData.length,
            validatedItemCount: sanitizeData.length - errors.length,
            validationErrors: errors
        };
    }

    async validateDataImport(sanitizeData: UploadTaxonomyExploitationInterface&lt;CellValue&gt;[]): Promise&lt;void&gt; {
        const indicatorNames &#x3D; Array.from(new Set(sanitizeData.map((item) &#x3D;&gt; item.indicator.toString())));
        const foundIndicators &#x3D; await this.categoryRepo
            .createQueryBuilder(&#x27;indicator&#x27;)
            .leftJoinAndSelect(&#x27;indicator.category&#x27;, &#x27;category&#x27;)
            .where(&#x27;indicator.name IN (:...indicatorNames)&#x27;, { indicatorNames })
            .distinctOn([&#x27;indicator.name&#x27;])
            .getMany();
        const indicatorMap &#x3D; keyBy(foundIndicators, &#x27;name&#x27;);
        for (const { category, indicator } of sanitizeData) {
            const foundIndicator &#x3D; indicatorMap[indicator.toString()];
            if (foundIndicator &amp;&amp; foundIndicator.category?.name !&#x3D;&#x3D; category) {
                throw new BadRequestException({
                    translate: &#x27;validation.failed_to_import_the_same_indicator_with_different_category&#x27;
                });
            }
        }
    }

    private async sanitizeData(fileTemplateData: UploadTaxonomyExploitationInterface&lt;CellValue&gt;[]) {
        const fileTemplateDataFilter &#x3D; fileTemplateData.reduce(
            (acc: UploadTaxonomyExploitationInterface&lt;CellValue&gt;[], rowData, index) &#x3D;&gt; {
                acc.push({ ...rowData, rowIndex: (index +&#x3D; 2) });
                return acc;
            },
            []
        );
        return uniqBy(fileTemplateDataFilter, (rowData) &#x3D;&gt; [rowData.indicator, rowData.subIndicator].join());
    }

    private async insertCategories(categories: string[]) {
        const partialCategories: Partial&lt;CategoryEntity&gt;[] &#x3D; [];
        const existingCategories &#x3D; await this.categoryRepo.find({
            where: { type: CategoryTypeEnum.CATEGORY }
        });
        for (const name of categories) {
            const category &#x3D; existingCategories.find((cate) &#x3D;&gt; cate.name &#x3D;&#x3D;&#x3D; name);
            if (category) continue;
            partialCategories.push({
                name: name.toString(),
                translation: { en: name.toString() },
                type: CategoryTypeEnum.CATEGORY
            });
        }
        return [...existingCategories, ...(await this.categoryRepo.save(partialCategories))];
    }

    private async saveIndicatorAndSubIndicators(
        groupedSubIndicators: UploadTaxonomyExploitationInterface&lt;CellValue&gt;[],
        categoriesGroupName: Dictionary&lt;CategoryEntity&gt;
    ) {
        const indicatorName &#x3D; get(groupedSubIndicators[0], &#x27;indicator&#x27;).toString();
        const categoryName &#x3D; get(groupedSubIndicators[0], &#x27;category&#x27;).toString();
        const indicator &#x3D; await this.categoryRepo.save({
            name: indicatorName,
            translation: { en: indicatorName },
            type: CategoryTypeEnum.INDICATOR,
            categoryId: categoriesGroupName[categoryName].id
        });
        indicator.category &#x3D; categoriesGroupName[categoryName];
        await this.insertedSubIndicators(groupedSubIndicators, indicator);
    }

    private insertedSubIndicators(
        insertedSubIndicator: UploadTaxonomyExploitationInterface&lt;CellValue&gt;[],
        foundIndicator: CategoryEntity
    ) {
        return this.categoryRepo.save(
            insertedSubIndicator.map(({ subIndicator, severity }) &#x3D;&gt; ({
                parentId: foundIndicator.id,
                name: subIndicator.toString(),
                translation: { en: subIndicator.toString() },
                type: CategoryTypeEnum.SUB_INDICATOR,
                category: foundIndicator.category,
                riskSeverity: +severity,
                categoryId: foundIndicator.category.id
            }))
        );
    }
}
</code></pre>
    </div>

</div>













                   </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div>
</div>
               <!-- END CONTENT -->
           </div>
       </div>

          <label class="dark-mode-switch">
               <input type="checkbox">
               <span class="slider">
                    <svg class="slider-icon" viewBox="0 0 24 24" fill="none" height="20" stroke="#000" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" width="20" xmlns="http://www.w3.org/2000/svg">
                    <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"></path>
                    </svg>
               </span>
          </label>

       <script>
            var COMPODOC_CURRENT_PAGE_DEPTH = 1;
            var COMPODOC_CURRENT_PAGE_CONTEXT = 'injectable';
            var COMPODOC_CURRENT_PAGE_URL = 'TaxonomyExploitationUploadService.html';
            var MAX_SEARCH_RESULTS = 15;
       </script>

       <script>
               $darkModeToggleSwitchers = document.querySelectorAll('.dark-mode-switch input');
               checkToggle(darkModeState);
               if ($darkModeToggleSwitchers.length > 0) {
                    for (var i = 0; i < $darkModeToggleSwitchers.length; i++) {
                         $darkModeToggleSwitchers[i].addEventListener('change', function (event) {
                              darkModeState = !darkModeState;
                              toggleDarkMode(darkModeState);
                         });
                    }
               }
          </script>

       <script src="../js/libs/custom-elements.min.js"></script>
       <script src="../js/libs/lit-html.js"></script>

       <script src="../js/menu-wc.js" defer></script>
       <script nomodule src="../js/menu-wc_es5.js" defer></script>

       <script src="../js/libs/bootstrap-native.js"></script>

       <script src="../js/libs/es6-shim.min.js"></script>
       <script src="../js/libs/EventDispatcher.js"></script>
       <script src="../js/libs/promise.min.js"></script>
       <script src="../js/libs/zepto.min.js"></script>

       <script src="../js/compodoc.js"></script>

       <script src="../js/tabs.js"></script>
       <script src="../js/menu.js"></script>
       <script src="../js/libs/clipboard.min.js"></script>
       <script src="../js/libs/prism.js"></script>
       <script src="../js/sourceCode.js"></script>
          <script src="../js/search/search.js"></script>
          <script src="../js/search/lunr.min.js"></script>
          <script src="../js/search/search-lunr.js"></script>
          <script src="../js/search/search_index.js"></script>
       <script src="../js/lazy-load-graphs.js"></script>


    </body>
</html>
